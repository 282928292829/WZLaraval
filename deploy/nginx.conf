# /etc/nginx/sites-available/wasetzon.com
# Symlink to sites-enabled:
#   sudo ln -s /etc/nginx/sites-available/wasetzon.com /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx

# ─── HTTP → HTTPS redirect ────────────────────────────────────────────────────
server {
    listen 80;
    listen [::]:80;
    server_name wasetzon.com www.wasetzon.com;

    # Let's Encrypt ACME challenge (certbot uses this before redirect)
    location /.well-known/acme-challenge/ {
        root /var/www/wasetzon/public;
    }

    location / {
        return 301 https://wasetzon.com$request_uri;
    }
}

# ─── www → non-www redirect ──────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.wasetzon.com;

    ssl_certificate     /etc/letsencrypt/live/wasetzon.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wasetzon.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://wasetzon.com$request_uri;
}

# ─── Main HTTPS vhost ─────────────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name wasetzon.com;

    root /var/www/wasetzon/public;
    index index.php;

    # ── SSL (managed by certbot) ──────────────────────────────────────────────
    ssl_certificate     /etc/letsencrypt/live/wasetzon.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wasetzon.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # ── Security headers ──────────────────────────────────────────────────────
    add_header X-Frame-Options           "SAMEORIGIN"             always;
    add_header X-Content-Type-Options    "nosniff"                always;
    add_header X-XSS-Protection          "1; mode=block"          always;
    add_header Referrer-Policy           "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy        "geolocation=(), microphone=()" always;

    # ── Gzip ──────────────────────────────────────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript
               application/rss+xml application/atom+xml image/svg+xml
               application/x-font-ttf font/opentype;

    # ── Client timeouts / body size ───────────────────────────────────────────
    client_max_body_size 64M;
    client_body_timeout  60s;
    send_timeout         60s;

    # ── Legacy order URL redirect (66k+ URLs) ─────────────────────────────────
    # WordPress used /order/{id} — Laravel uses /orders/{id}
    rewrite ^/order/(.*)$ /orders/$1 permanent;

    # ── Static assets: long cache, no logging ─────────────────────────────────
    location ~* \.(css|js|woff2?|ttf|otf|eot|svg|ico|png|jpg|jpeg|gif|webp|avif|mp4|webm)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # ── Service worker: never cache ────────────────────────────────────────────
    location = /sw.js {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # ── manifest.json: short cache ─────────────────────────────────────────────
    location = /manifest.json {
        expires 1d;
        add_header Cache-Control "public";
    }

    # ── robots.txt ────────────────────────────────────────────────────────────
    location = /robots.txt {
        access_log off;
        log_not_found off;
    }

    # ── favicon ───────────────────────────────────────────────────────────────
    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }

    # ── Main PHP routing ──────────────────────────────────────────────────────
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ── PHP-FPM ───────────────────────────────────────────────────────────────
    location ~ \.php$ {
        fastcgi_pass   unix:/var/run/php/php8.3-fpm.sock;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include        fastcgi_params;

        fastcgi_read_timeout    120s;
        fastcgi_buffers         16 16k;
        fastcgi_buffer_size     32k;
    }

    # ── Block hidden files (.env, .git, etc.) ─────────────────────────────────
    location ~ /\.(env|git|htaccess|DS_Store) {
        deny all;
        return 404;
    }

    # ── Block direct access to storage/vendor ─────────────────────────────────
    location ~ ^/(storage|vendor)/ {
        deny all;
        return 404;
    }

    # ── Logging ───────────────────────────────────────────────────────────────
    access_log /var/log/nginx/wasetzon.access.log;
    error_log  /var/log/nginx/wasetzon.error.log  warn;
}
